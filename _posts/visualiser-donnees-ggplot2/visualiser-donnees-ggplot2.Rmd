---
title: "Visualisation de données"
description: |
  Créer des graphiques avec ggplot2.
author:
  - name: Jonathan Kitt
date: 2022-06-30
categories:
  - R
  - RStudio
  - Graphiques
  - ggpplot2
  - Tidyverse
output:
  distill::distill_article:
    toc: true
    toc_depth: 1
    self_contained: false
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction

```{r, layout="l-body"}
knitr::include_graphics("img/ggplot2_blank.png")
```
Dessin de [Allison Horst](https://github.com/allisonhorst/stats-illustrations/blob/master/rstats-blanks/ggplot2_blank.png)

<br>

Nous avons vu comment [importer nos données dans RStudio](https://codons.netlify.app/posts/premiers-pas-avec-r/), et comment [les manipuler et les mettre en forme](https://codons.netlify.app/posts/manipuler-donnees-tidyverse/).  

<br>

Dans ce tutoriel nous allons voir comment communiquer les résultats de nos analyses - à l'aide de la **visualisation de données** :

<br>

**1. [Construire un graphique `ggplot2`](#construction)**  

**3. [Créer des graphiques basiques](#creer)** :  

- [nuage de points (scatter plot)](#scatterplot) 

- [histogramme](#histogram)  
  
- [boîtes à moustaches (box plot)](#boxplot)  
  
- [diagramme en bâtons (bar plot)](#barplot)  

- [graphiques multiples (facet)](#facet)

**3. [Exporter un graphique](#exporter)**

**4. [Améliorer ses graphiques](#ameliorer)**

**5. [Assembler ses graphiques à l'aide de `patchwork`](#patchwork)**

**6. [Défi](#defi)**

<br> 

# Construire un graphique `ggplot2` {#construire}

Le package `ggplot2` (qui fait partie de la suite Tidyverse) repose sur le principe de **grammaire des graphiques** : notre visualisation se construit étape par étape, en procédant par **couches**, comme le montre la figure ci-dessous.

```{r, layout="l-body"}
knitr::include_graphics("img/ggplot-grammar-of-graphics.png")
```
Figure tirée de [ggplot2 et la grammaire des graphiques](https://larmarange.github.io/analyse-R/ggplot2.html)

<br>

Toutes ces couches ne sont pas nécessaires à la construction d'un graphique.  
La figure ci-dessous montre de manière simplifiée comment créer un `ggplot` basique : 

**1) `ggplot()`** : initialisation de l'outil graphique  

**2) `aes()`** : paramètres esthétiques (répartition des variables sur les axes, couleurs, ...)  

**3) `geom()`** : type de représentation (points, lignes, ...)  

**4) `theme()`** : apparence du graphique (arrière-plan, taille et alignement du texte, ...)

```{r, layout="l-page"}
knitr::include_graphics("img/ggplot_01.gif")
```

Vous remarquerez dans le code la présence du signe **"+"** à la fin de chaque ligne : c'est ce qui permet d'ajouter une couche à votre graphique.

# Créer des graphiques basiques {#creer}

Commençons par ouvrir un nouveau script R et importer le jeu de données :

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)

pingouins <- readr::read_csv("https://raw.githubusercontent.com/codons-blog/C-04-VisualisationDonnees/main/pingouins.csv")
```

```{r, echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE}
# Ateliers codons!
# 04 - Visualisation de donnees avec ggplot2
# 2022-06-30

# Definir le repertoire de travail ----

setwd("codons/C-04-VisualisationDonnees")

# Charger le Tidyverse ----

library(tidyverse)

# Importer le jeu de donnees ----

pingouins <- readr::read_csv("https://raw.githubusercontent.com/codons-blog/C-04-VisualisationDonnees/main/pingouins.csv")
```

<br>

Il est toujours utile de vérifier les données importées avant d'aller plus loin :

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
glimpse(pingouins)
```

<br>

Il s'agit du jeu de données [Palmer penguins](https://allisonhorst.github.io/palmerpenguins/), disponible dans le package R [palmerpenguins](https://cloud.r-project.org/web/packages/palmerpenguins/index.html).  

Différents paramètres ont été mesurés sur trois espèces de pingouins, sur trois îles de l'archipel Palmer en Antarctique. 

```{r, layout="l-body"}
knitr::include_graphics("img/lter_penguins.png")
```
Dessin de [Allison Horst](https://allisonhorst.github.io/palmerpenguins/reference/figures/lter_penguins.png)

## Nuage de points (scatter plot){#scatterplot}

Intéressons-nous au bec des pingouins en répondant à la question suivante : **quelle est la distribution du rapport entre la hauteur du bec et sa longueur ?**.  
  
Afin de bien comprendre comment construire un graphique avec `ggplot2`, procédons étape par étape.

<br>

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Initialiser l'outil graphique
ggplot(data = pingouins)
```

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Paramètres esthétiques : répartition des variables sur les axes
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm))
```

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Type de visualisation : points
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point()
```

<br>

Voilà la distribution que nous cherchons à observer. C'est un bon début, mais cela manque de couleurs ...  

Il existe deux façons d'ajouter des couleurs à un `ggplot` :  

- **définir une couleur pour l'ensemble des points** : on placera alors le paramètre couleur **en dehors de la parenthèse `aes()`**.

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Une couleur pour l'ensemble des points
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(colour = "red")
```

- **colorer les points en fonction d'une autre variable** : on placera dans ce cas le paramètre couleur **à l'intérieur de la parenthèse `aes()`**.

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Colorer les points en fonction de l'espece
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(aes(colour = espece))
```

Vous pouvez voir qu'une **légende** permettant de différencier les trois espèces a été ajoutée à droite du graphique.

Nous aimerions utiliser les mêmes couleurs que celles de la documentation du jeu de données. Nous utilisons pour cela le paramètre `scale_colour_manual()` : 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Modifier les couleurs
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(aes(colour = espece)) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4"))
```

La taille des points nous semble trop petite : nous allons l'augmenter à l'aide de `size` :

<aside>
Prend une valeur numérique, par défaut 1
</aside>

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Augmenter la taille des points
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(aes(colour = espece),
             size = 3) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4"))
```

Afin de rendre le graphique plus lisible, nous pouvons ajouter de la transparence aux points à l'aide du paramètre `alpha` : 

<aside>
Entre 0 et 1, par opacité croissante
</aside>

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Ajouter de la transparence
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(aes(colour = espece),
             size = 3,
             alpha = 0.5) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4"))
```

Nous allons maintenant ajouter un titre et un sous-titre à notre graphique, et modifier les titres des axes pour les rendre plus explicites : 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Ajouter ou modifier les titres du graphique et des axes
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(aes(colour = espece),
             size = 3,
             alpha = 0.5) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Rapport entre la hauteur et la longueur du bec",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur du bec (mm)",
       y = "Hauteur du bec (mm)")
```

Le fond gris du graphique est proposé par défaut par `ggplot2` : il s'agit d'un **thème** définissant l'apparence générale du graphique (couleurs de l'arrière-plan, de la grille, présence ou non d'un cadre, ...).
Nous allons utiliser l'un des autres thèmes prédéfinis dans `ggplot2`, le thème **"minimal"** à l'aide du paramètre `theme_minimal()`.

<br>
Il en existe d'autres : `theme_light()`, `theme_bw()`, `theme_void()`, ... 
N'hésitez pas à les essayer pour trouver celui qui vous convient le mieux ! 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Changer le thème
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(aes(colour = espece),
             size = 3,
             alpha = 0.5) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Rapport entre la hauteur et la longueur du bec",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur du bec (mm)",
       y = "Hauteur du bec (mm)") +
  theme_minimal()
```

### Une note sur les formes et les couleurs

Nous pourrions également modifier la forme de nos points, à l'aide du paramètre `shape`. 
Il existe 25 types de points, comme montré ci-dessous.

```{r, layout="l-body"}
knitr::include_graphics("img/geom_point_shapes.png")
```

La façon de colorer les points dépend de la forme choisie : 

- couleur appliquée au **contour** pour les formes **0 à 14** à l'aide de `colour = ...`  

- couleur appliquée à l'**intérieur** pour les formes **15 à 20** à l'aide de `fill = ...`  

- couleur appliquée **au contour et à l'intérieur** pour les formes **21 à 24** à l'aide de ces deux paramètres, avec la même couleur ou des couleurs différentes. Pour ces cinq formes, la largeur du contour peut être modifiée à l'aide de `stroke = ...` (prend une valeur numérique).

Pour donner un exemple, nous pouvons ajouter à nos points un contour noir : 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Changer la forme des points
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(aes(fill = espece),
             shape = 23,
             stroke = 2,
             colour = "black",
             size = 3,
             alpha = 0.5) +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Rapport entre la hauteur et la longueur du bec",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur du bec (mm)",
       y = "Hauteur du bec (mm)") +
  theme_minimal()
```

**Attention à la logique du code !!** Nous avons choisi de colorer l'intérieur de nos points en fonction de l'espèce : `geom_point(aes(fill = espece))`. Il faut donc modifier la ligne qui nous permet de changer les couleurs : **`scale_fill_manual()`** remplace `scale_colour_manual()` utilisé précédemment. 

<br>

Le package `ggplot2` propose de nombreuses palettes de couleurs : 

<aside>
[Palettes prédéfinies dans `ggplot2`](http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#rcolorbrewer-palette-chart)
</aside>

```{r, layout="l-body"}
knitr::include_graphics("img/rcolorbrewer.png")
```

Ces différentes palettes peuvent être utilisées à l'aide de `scale_colour_brewer()` ou `scale_fill_brewer()`.
Essayons la palette *Set3* : 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Utiliser une palette de couleurs
ggplot(data = pingouins,
       mapping = aes(x = bec_lngr_mm,
                     y = bec_htr_mm)) +
  geom_point(aes(colour = espece),
             size = 3,
             alpha = 0.5) +
  scale_colour_brewer(palette = "Set3") +
  labs(title = "Rapport entre la hauteur et la longueur du bec",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur du bec (mm)",
       y = "Hauteur du bec (mm)") +
  theme_minimal()
```

Il existe beaucoup d'autres palettes, accessibles via des packages, dont la liste est [accessible ici](https://github.com/EmilHvitfeldt/r-color-palettes).

## Histogramme {#histogram}

Essayons maintenant de répondre à la question suivante : **quelle est la distribution de la longueur des ailes ?**.
<br>
Nous allons pour cela générer un histogramme à l'aide de `geom_histogram()` :

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Histogramme
ggplot(data = pingouins,
       mapping = aes(x = aile_lngr_mm)) +
  geom_histogram(aes(fill = espece),
                 alpha = 0.5) +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la longueur des ailes",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur des ailes (mm)",
       y = "Fréquence") +
  theme_minimal()
```

Il existe trois manières d'arranger la position des histogrammes des différents groupes : 

**1) `position = "stack` (par défaut)** : voir ci-dessus.

**2) `position = "identity`** : 
```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Histogramme - position = "identity"
ggplot(data = pingouins,
       mapping = aes(x = aile_lngr_mm)) +
  geom_histogram(aes(fill = espece),
                 alpha = 0.5,
                 position = "identity") +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la longueur des ailes",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur des ailes (mm)",
       y = "Fréquence") +
  theme_minimal()
```

**3) `position = "dodge`** 
```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Histogramme - position = "dodge"
ggplot(data = pingouins,
       mapping = aes(x = aile_lngr_mm)) +
  geom_histogram(aes(fill = espece),
                 alpha = 0.5,
                 position = "dodge") +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la longueur des ailes",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur des ailes (mm)",
       y = "Fréquence") +
  theme_minimal()
```

Lorsque vous exécutez ce code, vous pouvez lire le message suivant dans la console : **`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.**

<br>

Cela vous signale que le nombre de classes (bins) choisi pour l'histogramme n'est peut-être pas idéal.

<br>

Vous pouvez modifier ces classes de deux façons : 

**1) en modifiant la largeur de chaque classe sur l'axe x : `binwidth = ...`**

**2) en modifiant le nombre de classes à afficher : `bins = ...`**

<br>

Modifions ces paramètres pour voir le résultat : 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Histogramme - position = "identity" - binwidth = 0.5
ggplot(data = pingouins,
       mapping = aes(x = aile_lngr_mm)) +
  geom_histogram(aes(fill = espece),
                 alpha = 0.5,
                 position = "identity",
                 binwidth = 0.5) +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la longueur des ailes",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur des ailes (mm)",
       y = "Fréquence") +
  theme_minimal()
```

<br>

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Histogramme - position = "identity" - bins = 15
ggplot(data = pingouins,
       mapping = aes(x = aile_lngr_mm)) +
  geom_histogram(aes(fill = espece),
                 alpha = 0.5,
                 position = "identity",
                 bins = 15) +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la longueur des ailes",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Longueur des ailes (mm)",
       y = "Fréquence") +
  theme_minimal()
```

## Boîtes à moustaches (box plot) {#boxplot}

Intéressons-nous maintenant à la masse de nos pingouins : **les masses des trois espèces sont-elles similaires ?**  

<br>

Nous allons créer un graphique en boîte à moustaches à l'aide de `geom_boxplot()` : 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Boxplots
ggplot(data = pingouins,
       mapping = aes(x = espece,
                     y = masse_g)) +
  geom_boxplot(aes(colour = espece)) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la masse corporelle",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Espèce",
       y = "Masse (g)") +
  theme_minimal()
```

Nous pouvons apporter quelques modifications à ce graphique : 

- comme il y a une boîte à moustaches par espèce, nous **pouvons supprimer la légende à l'aide de `show_legend = FALSE`**  

- pour la même raison, nous pouvons **supprimer le titre de l'axe x : `labs(x = "")`**  

- nous pouvons **supprimer les données aberrantes (outliers) : `outlier.shape = NA`**  

- **réduire la largeur des boxplots avec `width`**

- **ajouter de la couleur à l'intérieur des boîtes à moustaches avec `aes(fill = espece)`** : bien penser à ajouter `scale_fill_manual()` !

- **augmenter l'épaisseur des lignes avec `lwd`** (line width)

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Boxplots avec quelques modifications
ggplot(data = pingouins,
       mapping = aes(x = espece,
                     y = masse_g)) +
  geom_boxplot(aes(colour = espece,
                   fill = espece),
               show.legend = FALSE,
               outlier.shape = NA,
               width = 0.25,
               alpha = 0.5,
               lwd = 0.75) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la masse corporelle",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "",
       y = "Masse (g)") +
  theme_minimal()
```

<br>

Si nous préférons des boxplots horizontaux, nous pouvons procéder de deux façons : 

**1) inverser les variables x et y**, en pensant bien à modifier également les titres des axes avec `labs()` : 

```{r, echo=TRUE, eval=FALSE, message=FALSE, warning=FALSE}
# Boxplots horizontaux : inverser les variables x et y
ggplot(data = pingouins,
       mapping = aes(x = masse_g,
                     y = espece)) +
  geom_boxplot(aes(colour = espece,
                   fill = espece),
               show.legend = FALSE,
               outlier.shape = NA,
               width = 0.25,
               alpha = 0.5,
               lwd = 0.75) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la masse corporelle",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "Masse (g)",
       y = "") +
  theme_minimal()
```

<br>

**2) utiliser `coord_flip()`** pour inverser les coordonnées : 

```{r, echo=TRUE, eval=TRUE, message=FALSE, warning=FALSE}
# Boxplots horizontaux : inverser les coordonnées avec coord_flip()
ggplot(data = pingouins,
       mapping = aes(x = espece,
                     y = masse_g)) +
  geom_boxplot(aes(colour = espece,
                   fill = espece),
               show.legend = FALSE,
               outlier.shape = NA,
               width = 0.25,
               alpha = 0.5,
               lwd = 0.75) +
  scale_colour_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  scale_fill_manual(values = c("Adelie" = "darkorange",
                                 "Chinstrap" = "purple",
                                 "Gentoo" = "cyan4")) +
  labs(title = "Distribution de la masse corporelle",
       subtitle = "pour trois espèces de pingouins de l'archipel Palmer",
       x = "",
       y = "Masse (g)") +
  coord_flip() +
  theme_minimal()
```